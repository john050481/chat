<% layout('./layout/page') -%>
<% block('title', "Чат") -%>

<style>
  #contextmenu {
    position: absolute;
    border: 1px solid #bbb;
    background-color: white;
  }
  #contextmenu li{
    cursor: pointer;
  }
  .newsClass {
    background-color: #d774f5;
    clear: both
  }
  .newsMessage {
    background-color: white;
    transition-property: background-color;
    transition-duration: 2s;
  }
  span[data-message="true"],
  span[data-userid] {
    cursor: pointer;
  }
  #messageList {
    height: 400px;
    overflow-y: auto;
    float: left;
    width: 70%;
    border-radius: 5px;
    background-color: #f4edd1;
  }
  #usersList {
    height: 100px;
    overflow-y: auto;
    float: right;
    width: 30%;
    text-align: right;
    border-radius: 5px;
    background-color: #a4e0f6;
  }
  #userInfo {
    height: 300px;
    overflow-y: auto;
    float: right;
    width: 30%;
    text-align: right;
    border-radius: 5px;
    background-color: #f5ccd7;
    font-size: 0.7em
  }
  .namePublisher {
    position: relative;
    top: 7px;
    left: 2px;
    border: solid 1px #7922CC;
    font-size: 0.7em;
  }
  .userList {
    border: solid 1px #7922CC;
    font-size: 0.7em;
  }
  .leftColor {
    border-radius: 3px;
    background-color: #EEDDFF;
  }
  .rightColor {
    border-radius: 3px;
    background-color: #D9F0D7;
  }
  .leftMessage {
    text-align: left
  }
  .rightMessage {
    text-align: right
  }
  .centerMessage {
    text-align: center
  }
</style>

<div id = 'news' class = "list-unstyled newsClass">Новости:</div>

<p class="lead">Вы вошли как: <b><%=user.get('username')%></b></p>
<p class="lead">№ чата: <b><%=idChat%></b></p>

<script src="/socket.io/socket.io.js"></script>

<div id="room">
  <ul    id = 'messageList' class = "list-unstyled"></ul>
  <aside id = 'usersList'   class = "list-unstyled"></aside>
  <aside id = 'userInfo'    class = "list-unstyled"></aside>

  <form>
    <div style="display:inline-block; width: 100%">
      <textarea id = 'input' disabled autocomplete="off" autofocus placeholder="Сообщение..." style="width: 80%"></textarea>
      <input id = 'submit' disabled type="submit" style="width: auto">
    </div>
  </form>
</div>

<button id='getAllOnLineUsersForNsp' onclick='getAllOnLineUsersForNsp(event)'>Get all online users for nsp</button>
<button id='getAllIoSocketsForNspAndUserId' onclick='getAllIoSocketsForNspAndUserId(event)'>Get all my online sessions for curent nsp (chat)</button>
<button id='getAllIoSocketsForUserId' onclick='getAllIoSocketsForUserId(event)'>Get all my online sessions</button>
<button id='getMyIoAndSession' onclick='getMyIoAndSession(event)'>Get my io and session (in console)</button>

<script>
  let usernameFromEJS = '<%=user.get('username')%>';
  let userIdFromEJS = '<%=user.get('id')%>';
  let idChat = '<%=idChat%>';
  console.log('idChat = ', idChat);
  console.log('usernameFromEJSusernameFromEJSusernameFromEJS = ', usernameFromEJS);
  console.log('userIdFromEJSuserIdFromEJSuserIdFromEJS = ', userIdFromEJS);

  let news = $('#news');
  var input = $('#input');
  var submit = $('#submit');
  var messageList = $('#messageList');
  var asideUsersList = $('#usersList');
  var asideUserInfo = $('#userInfo');
  var form = $('#room form');
  let btngetAllOnLineUsersForNsp = $('#getAllOnLineUsersForNsp');

//  var socket = io.connect('', {
//    reconnection: true //false
//  });
  const socket = io('/secretchat-' + idChat);
  const socketRoot = io('/');

  socketRoot
      .on('sendNews', function(text){
          console.log('NEWS ROOT /, socketRoot.id = ', socketRoot.id);
          news.text('');
          let div = $('<div>').addClass('newsMessage').text(text).appendTo(news);
          setTimeout( () => div.css('background-color', '#d774f5'), 100 );
      });

  socket
      .on('error', function(reason) {
        console.log('ERR! sock ERROR!, reason = ', reason, typeof reason);
        if ( (reason == "handshake unauthorized") || (reason == "No session") || (reason == "Anonymous session may not connect") ) {
          printStatus("вы вышли из сайта, по причине: " + reason);
        } else {
          setTimeout(function() {
            console.log('ERR! sock connect again!');
            socket.connect();
          }, 500);
        }
      })
      .on('sendNews', function(text){
        console.log('NEWS for nsp');
        news.text('');
        let div = $('<div>').addClass('newsMessage').text(text).appendTo(news);
        setTimeout( () => div.css('background-color', '#ee886c'), 100 );
      })
      .on('message', function(message, username, userId) {
        console.log('on message from server, message, username, userId = ', message, username, userId);
        printMessage(message, username, userId);
      })
      .on('leave', function(username) {
        printStatus(username + " вышел из чата");
      })
      .on('join', function(username) {
        printStatus(username + " вошёл в чат");
      })
      .on('connect', function() {
        printStatus("соединение установлено, ваш socket.id = " + socket.id);
        form.on('submit', sendMessage);
        input.prop('disabled', false);
        submit.prop('disabled', false);
        getAllOnLineUsersForNsp();
      })
      .on('disconnect', function() {
        printStatus("соединение потеряно");
        form.off('submit', sendMessage);
        input.prop('disabled', true);
        submit.prop('disabled', true);
        //this.$emit('error');
      })
      .on('logout', function(sid ,cb) {
        clearAllMessage();
        cb && cb(true);
        //window.location.href = "/"
        setTimeout( () => window.location.href = "/", 0 );
      })
      .on('getAllOnLineUsersForNsp', function(users) {
        asideUsersList.text('');
        users.forEach( user => {
          $('<span>').addClass('userList leftColor').attr({'data-userid': user.userId}).text(user.username).appendTo(asideUsersList);
          //$('<li>').append($('<button>').text(user.username).attr({"onclick": "(function (event) {getUserInfo(event.target.id)})(event)", "name": user.username, id: user.userId})).appendTo(asideUsersList);
        });
      });

  function split_textarea(txt){
      let lines = txt.val().replace(/^[\n\r]+|[\n\r]+$/g,'').split(/[\n\r]+/);
      return lines;
  };

  function sendMessage(e) {

    console.log('lines: ', split_textarea(input));

    var text = input.val();
    if (!text) {
      e.preventDefault();
      input.focus();
      return;
    };
    socket.emit('message', text, function(username, userId) {
      console.log("data callback from server socketIO username, userId = ", username, userId);
      printMessage(text, username, userId);
    });

    input.val('');
    input.focus();
    return false;
  }

  function itsMe(username, userId) {
    //console.log(userId === userIdFromEJS, userId, userIdFromEJS);
    //console.log('usernameFromEJS === username   ', usernameFromEJS === username, usernameFromEJS, username);
    return userId === userIdFromEJS;
  };

  function printStatus(status) {
    $('<li>').addClass('centerMessage').append($('<i>').text(status)).appendTo(messageList);
    scrollDown();
  }

  function clearAllMessage() {
    messageList.text('');
    $('<li>').append($('<i>').text('Закрыты все сессии!')).appendTo(messageList);
    form.off('submit', sendMessage);
    input.prop('disabled', true);
    submit.prop('disabled', true);
  }

  function printMessage(text, username, userId) {
    let thisIsMyMessage = itsMe(username, userId);
    let li = $('<li>').addClass(thisIsMyMessage ? 'rightMessage' : 'leftMessage').appendTo(messageList);
    if (!thisIsMyMessage) {
      $('<span>').addClass('namePublisher leftColor').attr({'data-userid': userId}).text(thisIsMyMessage ? '' : username).appendTo(li);
      $('<br>').appendTo(li);
    };
    $('<span>').addClass(thisIsMyMessage ? 'rightColor' : 'leftColor').attr({'data-message': true}).text(text).appendTo(li);
    scrollDown();
  };

  function scrollDown() {
    //console.log(messageList, messageList.scrollTop, messageList.scrollHeight);
    messageList.scrollTop(messageList.get(0).scrollHeight);
  };

  function getAllOnLineUsersForNsp(e) {
    socket.emit('getAllOnLineUsersForNsp', 'anyData', function(users) {
      console.log("data callback from server socketIO, users = ", users);
      asideUserInfo.text('');
      users.forEach(user => {
        $('<div>').text('-----').appendTo(asideUserInfo);
        for (let key in user)
        $('<div>').text(key + ': ' + user[key]).appendTo(asideUserInfo);
      });
    });
  };

  function getAllIoSocketsForNspAndUserId(e) {
    socket.emit('getAllIoSocketsForNspAndUserId', 'anyData', function(mySockets) {
      console.log("data callback from server socketIO, mySockets = ", mySockets);
      asideUserInfo.text('');
      mySockets.forEach(session => {
        $('<div>').text('-----').appendTo(asideUserInfo);
        for (let key in session)
        $('<div>').text(key + ': ' + session[key]).appendTo(asideUserInfo);
      });
    });
  };

  function getAllIoSocketsForUserId(e) {
    socket.emit('getAllIoSocketsForUserId', 'anyData', function(mySockets) {
      console.log("data callback from server socketIO, mySockets = ", mySockets);
      asideUserInfo.text('');
      mySockets.forEach(session => {
        $('<div>').text('-----').appendTo(asideUserInfo);
        for (let key in session)
        $('<div>').text(key + ': ' + session[key]).appendTo(asideUserInfo);
      });
    });
  };

  function getUserInfo(userId) {
    //console.log("getUserInfo for usernames/id = ", e.target.name, e.target.id);
    socket.emit('getUserInfo', userId, function(userInfo) {
      //console.log("data callback from server socketIO, userInfo = ", userInfo);
      asideUserInfo.text('');
      $('<div>').text(userInfo.username).appendTo(asideUserInfo);
      $('<div>').text(userInfo.created).appendTo(asideUserInfo);
      $('<div>').text(userInfo.userId).appendTo(asideUserInfo);
    });
  };

  function getMyIoAndSession(e) {
    socket.emit('getMyIoAndSession', function(results) {
      console.log('####################################');
      console.log('Более полную и детальную информацию о сессии и сокетах смотрите в консоли НОДы!!!');
      console.log('####################################');
      for (let key in results) console.log(key, ' = ', results[key]);
      console.log('####################################');
    });
  };

  let room = document.getElementById('room');
  room.addEventListener('click', (e) => {
    $('#contextmenu').off().remove();
    userId = e.target.dataset.userid;
    itsMessage = e.target.dataset.message;
    if (userId) {
      getUserInfo(userId);
      //console.log(userId);
    };
    if (itsMessage) {
      input.val('"' + e.target.innerHTML + '" ');
      input.focus();
      //console.log(e.target.innerHTML);
    };
  });

  room.addEventListener("contextmenu", (e) => {
    e.preventDefault();
    $('#contextmenu').off().remove();
    let menu = $('<ul>').attr({id: 'contextmenu'}).addClass('contextmenu').css({left: e.pageX, top: e.pageY}).appendTo($('body')).click(function(e){console.log(e.target)});
    $('<li>').text('item1').appendTo(menu);
    $('<li>').text('item2').appendTo(menu);
    $('<li>').text('item3').appendTo(menu);
  });

</script>
